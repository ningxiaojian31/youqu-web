(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/netty/chat"],{5726:function(t,e,a){"use strict";(function(t){a("b554"),a("921b");n(a("66fd"));var e=n(a("b53e"));function n(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,a("6e42")["createPage"])},"6ac8":function(t,e,a){},"911a":function(t,a,n){"use strict";(function(t,o){Object.defineProperty(a,"__esModule",{value:!0}),a.default=void 0;c(n("3137"));var i=c(n("cf5f")),s=c(n("769f"));function c(t){return t&&t.__esModule?t:{default:t}}var u,l,r=function(){return Promise.all([n.e("common/vendor"),n.e("components/chatmsg")]).then(n.bind(null,"f0d0"))},d=(Date.parse(new Date),!1),f=!1,h={duration:1e4,sampleRate:44100,numberOfChannels:1,encodeBitRate:192e3,format:"mp3",frameSize:50},g={components:{chatMsg:r},data:function(){return{per_page:0,list:[],content:"",wsConn:!1,group:{},user:{},toUser:{},emoList:[],sch:0,oldsch:0,scrollTop:1e4,emoClass:"",aRecordClass:"",aRecordIng:!1,time:0,token:"",userId:0,chatData:{userid:"",friendid:"",nickname:"",image:""},myImage:"",style:{pageHeight:0,contentViewHeight:0,footViewHeight:90,mitemHeight:0}}},created:function(){var e=t.getSystemInfoSync();this.style.pageHeight=e.windowHeight,this.style.contentViewHeight=e.windowHeight-t.getSystemInfoSync().screenWidth/750*100-70,this.scrollToBottom()},onPageScroll:function(t){0!=t.scrollTop||f||(this.getList(),f=!0,setTimeout(function(){f=!1},2e3))},onLoad:function(a){var n=this;n.chatData={userid:a.userid,friendid:a.friendid,nickname:a.nickname,username:a.username,image:a.image},o("log","页面跳转成功==="+JSON.stringify(n.chatData)," at pages\\netty\\chat.vue:182"),t.getStorage({key:"user",success:function(t){n.token=t.data.token,n.userId=t.data.id,n.myImage=t.data.image}}),null!=n.token&&""!=n.token||t.navigateTo({url:"/pages/shilu-login/login"}),o("log","加载中---"," at pages\\netty\\chat.vue:198"),this.initList(),this.revMessage();var s=t.getSystemInfoSync();s.windowHeight,this.emoList=i.default.emoList(),l=wx.getRecorderManager(),l.onStop(function(t){t.tempFilePath&&n.recordUpload(t.tempFilePath)}),l.onError(function(t){o("log",e," at pages\\netty\\chat.vue:224")})},onHide:function(){if(d)return!1;u.close({success:function(t){}})},onShow:function(){if(d)return!1;var t=this;this.wsConn&&t.wsInit()},methods:{scrollY:function(t){this.sch=t.detail.scrollHeight},scTop:function(t){0==this.oldsch&&(this.oldsch=this.sch);var e=this;e.scrollTop=0,this.getList()},toPersonal:function(){var e=this;t.navigateTo({url:"../me/personal?userId="+e.chatData.friendid})},revMessage:function(){var t=this;Vue.prototype.socketTask.onMessage(function(e){o("log","收到服务器内容："+e.data," at pages\\netty\\chat.vue:273"),o("log","更新消息成功========="," at pages\\netty\\chat.vue:275");var a=JSON.parse(e.data);t.list.push(a.chatRecord),t.scrollToBottom()})},initList:function(t){var e=this,a=s.default.apiHost+"/chat/chatrecord/findByUserIdAndFriendId?userid="+this.chatData.userid+"&friendid="+this.chatData.friendid,n="GET";s.default.request(a,null,n).then(function(t){o("log","加载当前聊天======="," at pages\\netty\\chat.vue:287"),e.list=t.data,setTimeout(function(){e.scrollToBottom()},0)}).catch(function(t){o("log","加载当前聊天发生异常"," at pages\\netty\\chat.vue:294")})},send:function(t,e){var a,n=this;switch(t){case"pic":a="[img="+e+"]";break;case"audio":a="[audio="+e+"]";break;case"video":a="[video="+e+"]";break;case"file":a=e.substring(e.lastIndexOf("/")+1)+" [file="+e+"]";break;case"content":if(a=n.content,""==a)return!1;break}var i=s.default.getMessage(s.default.MSG_TYPE_SEND,this.chatData.userid,this.chatData.friendid,a,null,null);o("log",i," at pages\\netty\\chat.vue:324"),i,Vue.prototype.socketTask.send({data:JSON.stringify(i),success:function(){o("log",JSON.stringify(i)," at pages\\netty\\chat.vue:330"),o("log","更新消息成功========="," at pages\\netty\\chat.vue:332"),n.list.push(i.chatRecord),setTimeout(function(){n.content=""},0),n.scrollToBottom()},fail:function(){o("log","发送失败========"," at pages\\netty\\chat.vue:342")}})},scrollToBottom:function(){o("log","滑动了============="," at pages\\netty\\chat.vue:351");var e=this,a=t.createSelectorQuery();a.selectAll(".m-item").boundingClientRect(),a.select("#scrollview").boundingClientRect(),a.exec(function(t){e.style.mitemHeight=0,t[0].forEach(function(t){return e.style.mitemHeight=e.style.mitemHeight+t.height+40}),setTimeout(function(){e.style.mitemHeight>e.style.contentViewHeight-100&&(e.scrollTop=e.style.mitemHeight-e.style.contentViewHeight)},100)})},addEmo:function(t){t="\\"+t+" ",this.content+=t},choiceImg:function(){var e=this;d=!0,t.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album"],fail:function(t){d=!1},success:function(a){d=!1;var n="";t.uploadFile({url:s.default.apiHost+"/other/qiniu/file/upload",filePath:a.tempFilePaths[0],header:{"Content-Type":"multipart/form-data",token:e.token},name:"file",formData:{file:"file"},success:function(a){o("log","上传"," at pages\\netty\\chat.vue:401"),405===a.statusCode&&(o("log","未登陆"," at pages\\netty\\chat.vue:403"),t.navigateTo({url:"/pages/shilu-login/login"}));var i=JSON.parse(a.data);1===i.code&&(n=i.data,e.send("pic",n))}})}})},catchImg:function(){var e=this;d=!0,t.chooseImage({fail:function(t){d=!1},sourceType:["camera"],success:function(a){d=!1;var n="";t.uploadFile({url:s.default.apiHost+"/other/qiniu/file/upload",filePath:a.tempFilePaths[0],header:{"Content-Type":"multipart/form-data",token:e.token},name:"file",formData:{file:"file"},success:function(a){o("log","上传"," at pages\\netty\\chat.vue:471"),405===a.statusCode&&(o("log","未登陆"," at pages\\netty\\chat.vue:473"),t.navigateTo({url:"/pages/shilu-login/login"}));var i=JSON.parse(a.data);1===i.code&&(n=i.data,e.send("pic",n))}})}})},videoRecord:function(){var e=this;t.chooseVideo({count:1,success:function(a){var n="";t.uploadFile({url:s.default.apiHost+"/other/qiniu/file/upload",filePath:a.tempFilePath,header:{"Content-Type":"multipart/form-data",token:e.token},name:"file",formData:{file:"file"},success:function(a){o("log","上传"," at pages\\netty\\chat.vue:509"),405===a.statusCode&&(o("log","未登陆"," at pages\\netty\\chat.vue:511"),t.navigateTo({url:"/pages/shilu-login/login"})),o("log",a," at pages\\netty\\chat.vue:516"),o("log",a.data," at pages\\netty\\chat.vue:517");var i=JSON.parse(a.data);1===i.code&&(n=i.data,e.send("video",n))}})}})},recordUpload:function(e){var a=this;o("log",e," at pages\\netty\\chat.vue:532");var n="";t.uploadFile({url:s.default.apiHost+"/other/qiniu/file/upload",filePath:e,header:{"Content-Type":"multipart/form-data",token:a.token},name:"file",formData:{file:"file"},success:function(e){o("log","上传"," at pages\\netty\\chat.vue:548"),405===e.statusCode&&(o("log","未登陆"," at pages\\netty\\chat.vue:550"),t.navigateTo({url:"/pages/shilu-login/login"})),o("log",e," at pages\\netty\\chat.vue:555"),o("log",e.data," at pages\\netty\\chat.vue:556");var i=JSON.parse(e.data);1===i.code&&(n=i.data,a.send("audio",n))}})},aRecordToggle:function(){this.aRecordIng?(o("log","stop"," at pages\\netty\\chat.vue:569"),l.stop(),this.aRecordIng=!1):(this.aRecordIng=!0,l.start(h))}}};a.default=g}).call(this,n("6e42")["default"],n("0de9")["default"])},9483:function(t,e,a){"use strict";a.r(e);var n=a("911a"),o=a.n(n);for(var i in n)"default"!==i&&function(t){a.d(e,t,function(){return n[t]})}(i);e["default"]=o.a},b53e:function(t,e,a){"use strict";a.r(e);var n=a("f74a"),o=a("9483");for(var i in o)"default"!==i&&function(t){a.d(e,t,function(){return o[t]})}(i);a("b5f7");var s,c=a("f0c5"),u=Object(c["a"])(o["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],s);e["default"]=u.exports},b5f7:function(t,e,a){"use strict";var n=a("6ac8"),o=a.n(n);o.a},f74a:function(t,e,a){"use strict";var n,o=function(){var t=this,e=t.$createElement;t._self._c;t._isMounted||(t.e0=function(e){t.aRecordClass="flex-col"},t.e1=function(e){t.emoClass="flex-col"},t.e2=function(e){t.emoClass=""},t.e3=function(e){t.aRecordClass=""})},i=[];a.d(e,"b",function(){return o}),a.d(e,"c",function(){return i}),a.d(e,"a",function(){return n})}},[["5726","common/runtime","common/vendor"]]]);